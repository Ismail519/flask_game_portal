{% extends 'base.html' %}

{% block content %}
{{ super() }}

{% for cat, msg in get_flashed_messages(True) %}
<div class="flash {{cat}}">{{msg}}</div>
{% endfor %}

<div class="profile-container">
    <h1>{{game.title}}</h1>
</div>

<div class="game-layout">
    <div class="game-frame-container">
        {% if game.type == 'link' %}
            <iframe src="{{ game.link }}" id="game-frame" allowtransparency="true" class="game-frame" allow="fullscreen"></iframe>
            <div class="game-controls">
                <a id="fullscreen-btn">
                    <img src="{{ url_for('static', filename='images/fullscreen-button.png') }}" alt="Fullscreen" class="fullscreen-icon">
                </a>
            </div>
        {% elif game.type == 'pygame' %}
            <iframe src="{{ url_for('pygame') }}" id="game-frame" allowtransparency="true" class="game-frame" allow="fullscreen"></iframe>
            <div class="game-controls">
                <a id="fullscreen-btn">
                    <img src="{{ url_for('static', filename='images/fullscreen-button.png') }}" alt="Fullscreen" class="fullscreen-icon">
                </a>
            </div>
        {% elif game.type == 'unity' %}
            <iframe src="{{ url_for('static', filename='games/' + game.link + '/index.html') }}" id="game-frame" allowtransparency="true" class="game-frame" allow="fullscreen"></iframe>
        {% endif %}
    </div>

    <div class="game-meta">
        <div class="game-type">
            {% if game.type == 'link' %}
                <img src="{{ url_for('static', filename='images/type/web.png') }}" alt="Web" class="type-icon">
                <span>Web</span>
            {% elif game.type == 'pygame' %}
                <img src="{{ url_for('static', filename='images/type/pygame.png') }}" alt="Pygame" class="type-icon">
                <span>Pygame</span>
            {% elif game.type == 'unity' %}
                <img src="{{ url_for('static', filename='images/type/unity.png') }}" alt="Unity" class="type-icon">
                <span>Unity</span>
            {% endif %}
        </div>
        {% if game.genre %}
            <p class="game-genre"><strong>–ñ–∞–Ω—Ä:</strong> {{ game.genre }}</p>
        {% endif %}
        <button class="favorite-btn" data-game-id="{{ game.id }}" data-is-favorite="{{ 'true' if is_favorite else 'false' }}">
            {% if is_favorite %}
                <span class="favorite-icon">‚òÖ</span> –£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
            {% else %}
                <span class="favorite-icon">‚òÜ</span> –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
            {% endif %}
        </button>
        {% if game.installer %}
            <a href="{{ url_for('download_installer', game_id=game.id) }}" class="btn download-btn">üíæ–°–∫–∞—á–∞—Ç—å</a>
        {% endif %}
    </div>
</div>

<div class="game-info-container">
    <div id="game-info" class="game-info">
        <h2 style="text-align: center">–û –∏–≥—Ä–µ</h2>
        <hr>
        <p>{{ game.description | safe }}</p>
    </div>
</div>

<!-- –ë–ª–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
<div id="comments-section">
    <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
    <form id="comment-form">
        <textarea id="comment-text" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required></textarea>
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
    <div id="comments-container"></div>
</div>

<script>
    window.entityId = {{ game.id }};
    window.entityType = "game";
</script>
<script src="{{url_for('static', filename='js/fullscreen.js')}}" rel="javascript"></script>
<script src="{{url_for('static', filename='js/favorites.js')}}" rel="javascript"></script>
<script src="{{ url_for('static', filename='js/coments.js') }}" rel="javascript"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.cookie = "game_path={{ game.link }}; path=/; SameSite=Lax";
        console.log("game-layout:", document.querySelector('.game-layout'));

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏–≥—Ä—ã
        let startTime = Date.now();
        const gameId = {{ game.id }};

        function sendTimeSpent() {
            const timeSpent = Math.floor((Date.now() - startTime) / 1000); // –í—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            fetch(`/game/${gameId}/track_time`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ time_spent: timeSpent }),
            })
            .then(response => response.json())
            .then(data => console.log(data.message))
            .catch(error => console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Ä–µ–º–µ–Ω–∏:', error));
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', sendTimeSpent);

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
        setInterval(sendTimeSpent, 60000);
    });
</script>
{% endblock %}